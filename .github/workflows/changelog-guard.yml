name: Changelog Guard

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  push:
    branches: [main, master]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute changed files
        id: diff
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.event.pull_request.head.sha }}"
          else
            base="$(git rev-parse HEAD~1)"
            head="$(git rev-parse HEAD)"
          fi
          echo "BASE=$base" >> $GITHUB_OUTPUT
          echo "HEAD=$head" >> $GITHUB_OUTPUT
          git diff --name-only "$base" "$head" > changed.txt
          echo "Changed files:"; cat changed.txt

      - name: Validate changelog presence
        run: |
          set -euo pipefail
          must_guard=$(grep -E "^(04-tasklist\.md|05-plan\.md|docs/.*\.md|features/.*\.feature|graphs/rpg\.json|AGENTS\.md)$" -x changed.txt || true)
          if [[ -n "$must_guard" ]]; then
            if ! grep -qx "07-changelog.md" changed.txt; then
              echo "::error title=Changelog missing::Documentation/plan/tasklist changed but 07-changelog.md was not updated."
              echo "Changed governance-critical files:"
              echo "$must_guard"
              exit 1
            fi
          fi
          echo "Changelog guard passed."

      - name: Validate acceptance clause (tasklist)
        run: |
          # Ensure the acceptance clause with changelog/governance is present when tasklist changes
          if grep -qx "04-tasklist.md" changed.txt; then
            grep -q "changelog atualizado (\`07-changelog\\.md\`) e fluxo de governan√ßa seguido (\`08-governanca-atualizacoes\\.md\`)" 04-tasklist.md \
              || { echo "::error title=Tasklist clause missing::Required acceptance clause not present in 04-tasklist.md"; exit 1; }
          fi
